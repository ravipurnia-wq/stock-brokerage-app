<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Trading Platform</title>
    <!-- PayPal SDK - Client ID should be set from backend -->
    <script src="https://www.paypal.com/sdk/js?client-id=CLIENT_ID_PLACEHOLDER&components=buttons&currency=USD"></script>
    
    <!-- Chart.js for historical stock charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .auth-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }

        .auth-tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .auth-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: bold;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .trading-dashboard {
            display: none;
            grid-template-columns: 300px 1fr 1fr;
            gap: 30px;
            height: 100vh;
            overflow: hidden;
        }

        .dashboard-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow-y: auto;
            max-height: calc(100vh - 120px);
        }

        .watchlist-sidebar {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            height: calc(100vh - 60px);
            overflow-y: auto;
            position: sticky;
            top: 20px;
        }

        .watchlist-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .watchlist-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .watchlist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 8px;
            background: #f8f9ff;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            transition: all 0.2s;
        }

        .watchlist-item:hover {
            background: #f0f2ff;
            transform: translateX(5px);
        }

        .watchlist-item-info {
            flex: 1;
        }

        .watchlist-item-symbol {
            font-weight: bold;
            color: #667eea;
            font-size: 14px;
        }

        .watchlist-item-name {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .watchlist-item-price {
            font-weight: bold;
            color: #333;
            font-size: 14px;
            margin-right: 10px;
        }

        .watchlist-item-actions {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .watchlist-buy-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 11px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
        }

        .watchlist-buy-btn:hover {
            background: #218838;
        }

        .watchlist-buy-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .watchlist-remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 8px;
            font-size: 11px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .watchlist-remove-btn:hover {
            background: #c82333;
        }

        .watchlist-empty {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }

        .search-section {
            margin-bottom: 20px;
        }

        .search-section h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-dot.connected {
            background: #28a745;
            animation: pulse 2s infinite;
        }

        .status-dot.disconnected {
            background: #dc3545;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .user-info {
            color: #667eea;
            font-weight: 500;
        }

        .logout-btn {
            padding: 8px 16px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .market-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stock-card {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: transform 0.3s;
        }

        .stock-card:hover {
            transform: translateY(-5px);
        }

        .stock-symbol {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stock-price {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
            transition: color 0.5s;
        }

        .stock-change {
            font-size: 14px;
            font-weight: 500;
        }

        .buy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
            transition: background-color 0.2s;
            width: 100%;
        }

        .buy-btn:hover {
            background: #218838;
        }

        .buy-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .price-up {
            color: #28a745;
        }

        .price-down {
            color: #dc3545;
        }

        .price-neutral {
            color: #6c757d;
        }

        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
        }

        .search-result-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .search-result-item:hover {
            background-color: #f8f9ff;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-symbol {
            font-weight: bold;
            color: #667eea;
            font-size: 16px;
        }

        .search-result-name {
            color: #333;
            margin: 5px 0;
        }

        .search-result-details {
            font-size: 12px;
            color: #666;
        }

        .search-result-added {
            background-color: #f0f8f0;
            position: relative;
        }

        .search-result-added::after {
            content: "✓ Added";
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #28a745;
            font-weight: bold;
            font-size: 12px;
        }

        .add-stock-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }

        .add-stock-btn:hover {
            background: #5a6fd8;
        }

        .add-stock-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .messages-section {
            height: 400px;
            overflow-y: auto;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            padding: 15px;
            background: #fafafa;
        }

        .message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            background: white;
            font-size: 14px;
        }

        .message.market-data {
            border-left-color: #28a745;
        }

        .message.portfolio-update {
            border-left-color: #ffc107;
        }

        .message.error {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .timestamp {
            color: #666;
            font-size: 12px;
        }

        .portfolio-section h3 {
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
        }

        .balance-card {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }

        .balance-amount {
            font-size: 28px;
            font-weight: bold;
        }

        .holdings-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .holding-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .holding-symbol {
            font-weight: bold;
            color: #667eea;
        }

        .holding-quantity {
            color: #666;
        }

        .holding-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .sell-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 11px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
        }

        .sell-btn:hover {
            background: #c82333;
        }

        .sell-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-color: #28a745;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-color: #dc3545;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            position: relative;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 15px;
        }

        .close:hover {
            color: #000;
        }

        .modal h3 {
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
        }

        .order-summary {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .order-summary-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }

        .order-summary-row.total {
            font-weight: bold;
            border-top: 1px solid #ddd;
            padding-top: 10px;
            margin-top: 10px;
        }

        .add-balance-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
            font-weight: 500;
        }

        .add-balance-btn:hover {
            background: #5a6fd8;
        }

        /* Chart Modal Styles */
        .chart-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
        }

        .chart-modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 20px;
            border-radius: 15px;
            width: 95%;
            max-width: 1200px;
            height: 85vh;
            position: relative;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .chart-title {
            color: #667eea;
            font-size: 24px;
            font-weight: bold;
            margin: 0;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .period-btn {
            background: #f8f9ff;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .period-btn.active {
            background: #667eea;
            color: white;
        }

        .period-btn:hover {
            background: #5a6fd8;
            color: white;
            border-color: #5a6fd8;
        }

        .chart-container {
            flex: 1;
            position: relative;
            height: calc(85vh - 120px);
            min-height: 400px;
        }

        .chart-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #666;
            font-size: 18px;
        }

        .chart-error {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #dc3545;
            font-size: 16px;
            text-align: center;
        }

        .view-chart-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
            font-weight: 500;
        }

        .view-chart-btn:hover {
            background: #5a6fd8;
        }

        /* Financials Modal Styles */
        .financials-section {
            margin-bottom: 25px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border-left: 4px solid #667eea;
            transition: transform 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
        }

        .metric-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .metric-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .additional-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }

        .additional-metric-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f8f9ff;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .additional-metric-label {
            font-size: 14px;
            color: #555;
            font-weight: 500;
        }

        .additional-metric-value {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }

        .view-financials-btn {
            background: #ff9500;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
            font-weight: 500;
        }

        .view-financials-btn:hover {
            background: #e68700;
        }

        @media (max-width: 768px) {
            .trading-dashboard {
                grid-template-columns: 1fr;
            }
            
            .market-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .modal-content {
                width: 95%;
                margin: 5% auto;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 Stock Trading Platform</h1>
            <p>Real-time trading with live market data</p>
        </div>

        <!-- Authentication Section -->
        <div id="authSection" class="auth-section">
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchTab('login')">Login</button>
                <button class="auth-tab" onclick="switchTab('register')">Register</button>
            </div>

            <div id="alerts"></div>

            <!-- Login Form -->
            <form id="loginForm" class="auth-form active">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" name="email" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" name="password" required>
                </div>
                <button type="submit" class="btn">Login</button>
            </form>

            <!-- Registration Form -->
            <form id="registerForm" class="auth-form">
                <div class="form-group">
                    <label for="registerFirstName">First Name</label>
                    <input type="text" id="registerFirstName" name="firstName" required>
                </div>
                <div class="form-group">
                    <label for="registerLastName">Last Name</label>
                    <input type="text" id="registerLastName" name="lastName" required>
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email</label>
                    <input type="email" id="registerEmail" name="email" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" name="password" required minlength="6">
                </div>
                <div class="form-group">
                    <label for="registerConfirmPassword">Confirm Password</label>
                    <input type="password" id="registerConfirmPassword" name="confirmPassword" required minlength="6">
                </div>
                <button type="submit" class="btn">Create Account</button>
            </form>
        </div>

        <!-- Trading Dashboard -->
        <div id="tradingDashboard" class="trading-dashboard">
            <!-- Status Bar -->
            <div class="status-bar" style="grid-column: 1 / -1;">
                <div class="status-indicator">
                    <div id="statusDot" class="status-dot disconnected"></div>
                    <span id="statusText">Disconnected</span>
                </div>
                <div id="userInfo" class="user-info">Welcome, User!</div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>

            <!-- Watchlist Sidebar -->
            <div class="watchlist-sidebar">
                <div class="watchlist-header">
                    <h3 class="watchlist-title">📋 My Watchlist</h3>
                </div>
                
                <!-- Search Section -->
                <div class="search-section">
                    <h4>🔍 Add Stocks</h4>
                    <div class="search-container">
                        <input 
                            type="text" 
                            id="stockSearchInput" 
                            placeholder="Search stocks..."
                            class="search-input"
                        />
                        <div id="searchResults" class="search-results" style="display: none;">
                            <!-- Search results will appear here -->
                        </div>
                    </div>
                </div>

                <!-- Watchlist Items -->
                <div id="watchlistItems" class="watchlist-items">
                    <div class="watchlist-empty">
                        No stocks in watchlist. Search and add stocks above.
                    </div>
                </div>
            </div>

            <!-- Market Data Section -->
            <div class="dashboard-section">
                <h3>📈 Live Market Data</h3>
                <div id="marketGrid" class="market-grid">
                    <div class="stock-card">
                        <div class="stock-symbol">AAPL</div>
                        <div class="stock-price" id="price-AAPL">--</div>
                        <div class="stock-change" id="change-AAPL">--</div>
                    </div>
                    <div class="stock-card">
                        <div class="stock-symbol">GOOGL</div>
                        <div class="stock-price" id="price-GOOGL">--</div>
                        <div class="stock-change" id="change-GOOGL">--</div>
                    </div>
                    <div class="stock-card">
                        <div class="stock-symbol">MSFT</div>
                        <div class="stock-price" id="price-MSFT">--</div>
                        <div class="stock-change" id="change-MSFT">--</div>
                    </div>
                    <div class="stock-card">
                        <div class="stock-symbol">TSLA</div>
                        <div class="stock-price" id="price-TSLA">--</div>
                        <div class="stock-change" id="change-TSLA">--</div>
                    </div>
                    <div class="stock-card">
                        <div class="stock-symbol">AMZN</div>
                        <div class="stock-price" id="price-AMZN">--</div>
                        <div class="stock-change" id="change-AMZN">--</div>
                    </div>
                </div>

                <div class="messages-section" id="messagesSection">
                    <div class="loading">Connecting to market data...</div>
                </div>
            </div>

            <!-- Portfolio Section -->
            <div class="dashboard-section portfolio-section">
                <h3>💰 Your Portfolio</h3>
                
                <div class="balance-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>Available Balance</div>
                        <button class="add-balance-btn" onclick="openAddBalanceModal()">Add Balance</button>
                    </div>
                    <div class="balance-amount" id="availableBalance">$0.00</div>
                </div>

                <h4>Holdings</h4>
                <div class="holdings-list" id="holdingsList">
                    <div class="loading">Loading portfolio...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Buy Stock Modal -->
    <div id="buyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeBuyModal()">&times;</span>
            <h3>Buy Stock</h3>
            <form id="buyForm">
                <div class="form-group">
                    <label for="buySymbol">Stock Symbol</label>
                    <input type="text" id="buySymbol" readonly>
                </div>
                <div class="form-group">
                    <label for="buyCompanyName">Company Name</label>
                    <input type="text" id="buyCompanyName" readonly>
                </div>
                <div class="form-group">
                    <label for="buyQuantity">Quantity</label>
                    <input type="number" id="buyQuantity" min="1" value="1" required>
                </div>
                <div class="form-group">
                    <label for="buyOrderType">Order Type</label>
                    <select id="buyOrderType" onchange="togglePriceField()">
                        <option value="MARKET">Market Order</option>
                        <option value="LIMIT">Limit Order</option>
                    </select>
                </div>
                <div class="form-group" id="priceField" style="display: none;">
                    <label for="buyPrice">Limit Price ($)</label>
                    <input type="number" id="buyPrice" step="0.01" min="0.01">
                </div>
                
                <div class="order-summary">
                    <div class="order-summary-row">
                        <span>Current Price:</span>
                        <span id="currentPrice">--</span>
                    </div>
                    <div class="order-summary-row">
                        <span>Quantity:</span>
                        <span id="summaryQuantity">1</span>
                    </div>
                    <div class="order-summary-row">
                        <span>Estimated Value:</span>
                        <span id="estimatedValue">--</span>
                    </div>
                    <div class="order-summary-row">
                        <span>Fees (0.1%):</span>
                        <span id="estimatedFees">--</span>
                    </div>
                    <div class="order-summary-row total">
                        <span>Total Amount:</span>
                        <span id="totalAmount">--</span>
                    </div>
                </div>
                
                <button type="submit" class="btn">Place Buy Order</button>
            </form>
        </div>
    </div>

    <!-- Sell Stock Modal -->
    <div id="sellModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSellModal()">&times;</span>
            <h3>Sell Stock</h3>
            <form id="sellForm">
                <div class="form-group">
                    <label for="sellSymbol">Stock Symbol</label>
                    <input type="text" id="sellSymbol" readonly>
                </div>
                <div class="form-group">
                    <label for="sellCompanyName">Company Name</label>
                    <input type="text" id="sellCompanyName" readonly>
                </div>
                <div class="form-group">
                    <label for="sellQuantity">Quantity to Sell</label>
                    <input type="number" id="sellQuantity" min="1" value="1" required>
                    <small id="maxQuantityText" style="color: #666; font-size: 12px;">Max: 0 shares</small>
                </div>
                <div class="form-group">
                    <label for="sellOrderType">Order Type</label>
                    <select id="sellOrderType" onchange="toggleSellPriceField()">
                        <option value="MARKET">Market Order</option>
                        <option value="LIMIT">Limit Order</option>
                    </select>
                </div>
                <div class="form-group" id="sellPriceField" style="display: none;">
                    <label for="sellPrice">Limit Price ($)</label>
                    <input type="number" id="sellPrice" step="0.01" min="0.01">
                </div>
                
                <div class="order-summary">
                    <div class="order-summary-row">
                        <span>Current Price:</span>
                        <span id="sellCurrentPrice">--</span>
                    </div>
                    <div class="order-summary-row">
                        <span>Quantity:</span>
                        <span id="sellSummaryQuantity">1</span>
                    </div>
                    <div class="order-summary-row">
                        <span>Estimated Value:</span>
                        <span id="sellEstimatedValue">--</span>
                    </div>
                    <div class="order-summary-row">
                        <span>Fees (0.1%):</span>
                        <span id="sellEstimatedFees">--</span>
                    </div>
                    <div class="order-summary-row total">
                        <span>Net Amount:</span>
                        <span id="sellNetAmount">--</span>
                    </div>
                </div>
                
                <button type="submit" class="btn" style="background: #dc3545;">Place Sell Order</button>
            </form>
        </div>
    </div>

    <!-- Add Balance Modal -->
    <div id="addBalanceModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddBalanceModal()">&times;</span>
            <h3>Add Balance</h3>
            <form id="addBalanceForm">
                <div class="form-group">
                    <label for="addBalanceAmount">Amount ($)</label>
                    <input type="number" id="addBalanceAmount" step="0.01" min="0.01" max="10000" required>
                </div>
                <div class="form-group">
                    <label for="addBalanceMethod">Payment Method</label>
                    <select id="addBalanceMethod" required>
                        <option value="">Select payment method</option>
                        <option value="CREDIT_CARD">Credit Card</option>
                        <option value="DEBIT_CARD">Debit Card</option>
                        <option value="BANK_TRANSFER">Bank Transfer</option>
                        <option value="PAYPAL">PayPal</option>
                    </select>
                </div>
                
                <div class="order-summary">
                    <div class="order-summary-row">
                        <span>Amount to Add:</span>
                        <span id="summaryAmount">$0.00</span>
                    </div>
                    <div class="order-summary-row">
                        <span>Transaction Fee (1%):</span>
                        <span id="transactionFee">$0.00</span>
                    </div>
                    <div class="order-summary-row total">
                        <span>Total Charge:</span>
                        <span id="totalCharge">$0.00</span>
                    </div>
                </div>
                
                <!-- Payment Buttons -->
                <div id="payment-buttons-container">
                    <!-- PayPal Button Container (hidden by default) -->
                    <div id="paypal-add-balance-container" style="margin-top: 20px; display: none;"></div>
                    
                    <!-- Regular Submit Button -->
                    <button type="submit" class="btn" id="regular-add-balance">Add Balance</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Stock Chart Modal -->
    <div id="chartModal" class="chart-modal">
        <div class="chart-modal-content">
            <div class="chart-header">
                <h3 class="chart-title" id="chartTitle">Stock Chart - AAPL</h3>
                <div class="chart-controls">
                    <button class="period-btn active" data-period="1D">1D</button>
                    <button class="period-btn" data-period="1W">1W</button>
                    <button class="period-btn" data-period="1M">1M</button>
                    <button class="period-btn" data-period="3M">3M</button>
                    <button class="period-btn" data-period="1Y">1Y</button>
                    <span class="close" onclick="closeChartModal()" style="margin-left: 20px;">&times;</span>
                </div>
            </div>
            
            <div class="chart-container">
                <div id="chartLoading" class="chart-loading">
                    Loading chart data...
                </div>
                <div id="chartError" class="chart-error" style="display: none;">
                    Failed to load chart data. Please try again.
                </div>
                <canvas id="stockChart" style="display: none;"></canvas>
            </div>
        </div>
    </div>

    <!-- Financials Modal -->
    <div id="financialsModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeFinancialsModal()">&times;</span>
            <h3 id="financialsTitle">Company Financials - AAPL</h3>
            
            <div id="financialsContent">
                <div id="financialsLoading" class="loading">
                    Loading financial data...
                </div>
                <div id="financialsError" style="display: none; text-align: center; color: #dc3545; padding: 20px;">
                    Failed to load financial data. Please try again.
                </div>
                
                <div id="financialsData" style="display: none;">
                    <!-- Key Metrics Section -->
                    <div class="financials-section">
                        <h4 style="color: #667eea; margin-bottom: 15px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px;">📊 Key Metrics</h4>
                        <div class="metrics-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div class="metric-card">
                                <div class="metric-label">Market Cap</div>
                                <div class="metric-value" id="marketCap">--</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">P/E Ratio (TTM)</div>
                                <div class="metric-value" id="peRatio">--</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">P/B Ratio</div>
                                <div class="metric-value" id="pbRatio">--</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">EPS (TTM)</div>
                                <div class="metric-value" id="eps">--</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Dividend Yield</div>
                                <div class="metric-value" id="dividendYield">--</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">ROE (TTM)</div>
                                <div class="metric-value" id="roe">--</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">ROA (TTM)</div>
                                <div class="metric-value" id="roa">--</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Beta</div>
                                <div class="metric-value" id="beta">--</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">52W High</div>
                                <div class="metric-value" id="weekHigh52">--</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">52W Low</div>
                                <div class="metric-value" id="weekLow52">--</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Metrics Section -->
                    <div class="financials-section">
                        <h4 style="color: #667eea; margin-bottom: 15px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px;">📈 Additional Metrics</h4>
                        <div class="additional-metrics" id="additionalMetrics">
                            <!-- Additional metrics will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let socket = null;
        let authToken = null;
        let currentUser = null;
        let priceHistory = {};
        let cachedWatchlist = null;
        let watchlistCacheTime = null;
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

        // API Base URL - relative since we're on the same server
        const API_BASE = '/api/v1';

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            checkAuthStatus();
        });

        function setupEventListeners() {
            // Form submissions
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
        }

        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.auth-tab').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.auth-tab[onclick="switchTab('${tab}')"]`).classList.add('active');

            // Update forms
            document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
            document.getElementById(tab + 'Form').classList.add('active');

            clearAlerts();
        }

        async function handleRegister(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const password = formData.get('password');
            const confirmPassword = formData.get('confirmPassword');

            if (password !== confirmPassword) {
                showAlert('Passwords do not match', 'error');
                return;
            }

            const userData = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                email: formData.get('email'),
                password: password
            };

            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData)
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('Registration successful! Please login with your credentials.', 'success');
                    switchTab('login');
                    document.getElementById('registerForm').reset();
                } else {
                    showAlert(data.message || 'Registration failed', 'error');
                }
            } catch (error) {
                showAlert('Network error. Please try again.', 'error');
                console.error('Registration error:', error);
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const loginData = {
                email: formData.get('email'),
                password: formData.get('password')
            };

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(loginData)
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.accessToken;
                    currentUser = data.user;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    showAuthenticatedView();
                } else {
                    showAlert(data.message || 'Login failed', 'error');
                }
            } catch (error) {
                showAlert('Network error. Please try again.', 'error');
                console.error('Login error:', error);
            }
        }

        function checkAuthStatus() {
            const savedToken = localStorage.getItem('authToken');
            const savedUser = localStorage.getItem('currentUser');

            if (savedToken && savedUser) {
                authToken = savedToken;
                currentUser = JSON.parse(savedUser);
                showAuthenticatedView();
            }
        }

        function showAuthenticatedView() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('tradingDashboard').style.display = 'grid';
            
            // Update user info
            document.getElementById('userInfo').textContent = 
                `Welcome, ${currentUser.firstName} ${currentUser.lastName}!`;

            // Connect to WebSocket and load data
            connectWebSocket();
            loadPortfolio();
            loadMarketData();
            loadWatchlist();
        }

        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            
            if (socket) {
                socket.close();
                socket = null;
            }

            document.getElementById('authSection').style.display = 'block';
            document.getElementById('tradingDashboard').style.display = 'none';
            document.getElementById('loginForm').reset();
            clearAlerts();
            
            // Reset status
            updateConnectionStatus(false);
        }

        function connectWebSocket() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                return;
            }

            try {
                // Connect to WebSocket using relative URL
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/market-data`;
                socket = new WebSocket(wsUrl);
                
                socket.onopen = function(event) {
                    updateConnectionStatus(true);
                    addMessage('🔗 Connected to live market data!', 'success');
                };
                
                socket.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (e) {
                        addMessage('📨 Raw message: ' + event.data, 'info');
                    }
                };
                
                socket.onclose = function(event) {
                    updateConnectionStatus(false);
                    addMessage('🔌 Connection closed. Attempting to reconnect...', 'warning');
                    
                    // Attempt to reconnect after 5 seconds
                    setTimeout(() => {
                        if (authToken) {
                            connectWebSocket();
                        }
                    }, 5000);
                };
                
                socket.onerror = function(error) {
                    addMessage('❌ WebSocket error occurred', 'error');
                    console.error('WebSocket error:', error);
                };
                
            } catch (error) {
                addMessage('❌ Failed to connect: ' + error.message, 'error');
                console.error('WebSocket connection error:', error);
            }
        }

        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'CONNECTION_ESTABLISHED':
                    addMessage('🎉 ' + data.message, 'success');
                    break;
                    
                case 'MARKET_DATA_UPDATE':
                    updateStockPrice(data);
                    addMessage(`📈 ${data.symbol}: $${data.price} (Vol: ${data.volume})`, 'market-data');
                    break;
                    
                case 'PORTFOLIO_UPDATE':
                    addMessage(`💰 Portfolio Update: ${data.eventType}`, 'portfolio-update');
                    loadPortfolio(); // Refresh portfolio data
                    break;
                    
                case 'ORDER_UPDATE':
                    addMessage(`📋 Order Update`, 'portfolio-update');
                    break;
                    
                default:
                    addMessage('📨 ' + JSON.stringify(data), 'info');
            }
        }

        function updateStockPrice(data) {
            const priceElement = document.getElementById(`price-${data.symbol}`);
            const changeElement = document.getElementById(`change-${data.symbol}`);
            
            // Update main market grid prices
            if (priceElement) {
                const oldPrice = priceHistory[data.symbol] || 0;
                const newPrice = parseFloat(data.price);
                
                priceElement.textContent = `$${data.price}`;
                
                // Calculate change
                const change = newPrice - oldPrice;
                const changePercent = oldPrice > 0 ? ((change / oldPrice) * 100) : 0;
                
                if (oldPrice > 0) {
                    changeElement.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePercent.toFixed(2)}%)`;
                    
                    if (change > 0) {
                        priceElement.className = 'stock-price price-up';
                        changeElement.className = 'stock-change price-up';
                    } else if (change < 0) {
                        priceElement.className = 'stock-price price-down';
                        changeElement.className = 'stock-change price-down';
                    } else {
                        priceElement.className = 'stock-price price-neutral';
                        changeElement.className = 'stock-change price-neutral';
                    }
                } else {
                    changeElement.textContent = '--';
                }
                
                priceHistory[data.symbol] = newPrice;
                
                // Reset color after 2 seconds
                setTimeout(() => {
                    priceElement.className = 'stock-price';
                }, 2000);
            }
            
            // Update watchlist prices
            const watchlistPriceElement = document.getElementById(`watchlist-price-${data.symbol}`);
            if (watchlistPriceElement) {
                watchlistPriceElement.textContent = `$${data.price}`;
                
                // Add price change animation for watchlist
                watchlistPriceElement.style.color = '#28a745';
                setTimeout(() => {
                    watchlistPriceElement.style.color = '#333';
                }, 1000);
            }
        }

        async function loadPortfolio() {
            if (!authToken) return;

            try {
                // Load wallet balance
                const walletResponse = await fetch(`${API_BASE}/wallet`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (walletResponse.ok) {
                    const walletData = await walletResponse.json();
                    document.getElementById('availableBalance').textContent = 
                        `$${walletData.balance?.toFixed(2) || '0.00'}`;
                }

                // Load holdings
                const holdingsResponse = await fetch(`${API_BASE}/holdings`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (holdingsResponse.ok) {
                    const holdingsData = await holdingsResponse.json();
                    displayHoldings(holdingsData);
                }

            } catch (error) {
                console.error('Error loading portfolio:', error);
                addMessage('❌ Error loading portfolio data', 'error');
            }
        }

        function displayHoldings(holdings) {
            const holdingsList = document.getElementById('holdingsList');
            
            if (!holdings || holdings.length === 0) {
                holdingsList.innerHTML = '<div class="loading">No holdings found</div>';
                return;
            }

            holdingsList.innerHTML = holdings.map(holding => `
                <div class="holding-item">
                    <div>
                        <div class="holding-symbol">${holding.symbol}</div>
                        <div class="holding-quantity">${holding.quantity} shares</div>
                    </div>
                    <div>
                        <div>$${holding.averagePrice?.toFixed(2) || '0.00'}</div>
                        <div class="holding-quantity">Avg Price</div>
                    </div>
                    <div class="holding-actions">
                        <button class="sell-btn" onclick="openSellModal('${holding.symbol}', '${holding.companyName || holding.symbol}', ${holding.quantity})">
                            Sell
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updateConnectionStatus(connected) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (connected) {
                statusDot.className = 'status-dot connected';
                statusText.textContent = 'Connected';
            } else {
                statusDot.className = 'status-dot disconnected';
                statusText.textContent = 'Disconnected';
            }
        }

        function addMessage(message, type = 'info') {
            const messagesSection = document.getElementById('messagesSection');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `
                <span class="timestamp">[${new Date().toLocaleTimeString()}]</span> 
                ${message}
            `;
            
            messagesSection.appendChild(messageDiv);
            messagesSection.scrollTop = messagesSection.scrollHeight;
            
            // Keep only last 50 messages
            while (messagesSection.children.length > 50) {
                messagesSection.removeChild(messagesSection.firstChild);
            }
        }

        function showAlert(message, type) {
            const alertsDiv = document.getElementById('alerts');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            alertsDiv.appendChild(alertDiv);
            
            // Remove alert after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        function clearAlerts() {
            document.getElementById('alerts').innerHTML = '';
        }

        // Stock Search Functionality
        let searchTimeout;
        const stockSearchInput = document.getElementById('stockSearchInput');
        const searchResults = document.getElementById('searchResults');

        stockSearchInput.addEventListener('input', function() {
            const query = this.value.trim();
            
            // Clear previous timeout
            clearTimeout(searchTimeout);
            
            if (query.length < 2) {
                hideSearchResults();
                return;
            }
            
            // Debounce search to avoid too many API calls
            searchTimeout = setTimeout(() => {
                searchStocks(query);
            }, 300);
        });

        // Hide search results when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.search-container')) {
                hideSearchResults();
            }
        });

        async function searchStocks(query) {
            try {
                const response = await fetch(`${API_BASE}/market/search?query=${encodeURIComponent(query)}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Search failed');
                }

                const results = await response.json();
                displaySearchResults(results);
            } catch (error) {
                console.error('Error searching stocks:', error);
                hideSearchResults();
            }
        }

        function displaySearchResults(results) {
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="search-result-item">No stocks found</div>';
                searchResults.style.display = 'block';
                return;
            }

            searchResults.innerHTML = '';
            
            results.forEach(stock => {
                const resultItem = document.createElement('div');
                resultItem.className = `search-result-item ${stock.isAdded ? 'search-result-added' : ''}`;
                
                resultItem.innerHTML = `
                    <div class="search-result-symbol">${stock.symbol}</div>
                    <div class="search-result-name">${stock.companyName}</div>
                    <div class="search-result-details">${stock.exchange} • ${stock.sector}</div>
                `;
                
                if (!stock.isAdded) {
                    const addButton = document.createElement('button');
                    addButton.className = 'add-stock-btn';
                    addButton.textContent = 'Add to Watchlist';
                    addButton.onclick = function(event) {
                        event.stopPropagation();
                        addStock(stock.symbol, stock.companyName, stock.exchange, stock.sector);
                    };
                    resultItem.appendChild(addButton);
                    
                    resultItem.onclick = function() {
                        addStock(stock.symbol, stock.companyName, stock.exchange, stock.sector);
                    };
                }
                
                searchResults.appendChild(resultItem);
            });

            searchResults.style.display = 'block';
        }

        function hideSearchResults() {
            searchResults.style.display = 'none';
        }

        async function addStock(symbol, companyName, exchange, sector) {
            console.log('addStock called with:', { symbol, companyName, exchange, sector });
            console.log('authToken:', authToken);
            
            if (!authToken) {
                showAlert('Please login first to add stocks to your watchlist', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/market/add`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        companyName: companyName,
                        exchange: exchange,
                        sector: sector
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to add stock');
                }

                const addedStock = await response.json();
                
                // Show success message
                showAlert(`Successfully added ${symbol} to your watchlist!`, 'success');
                
                // Clear cache and refresh market data and watchlist to show the new stock
                setTimeout(() => {
                    cachedWatchlist = null;
                    watchlistCacheTime = null;
                    loadMarketData();
                    loadWatchlist(true); // Force refresh
                }, 1000);
                
                // Hide search results and clear input
                hideSearchResults();
                stockSearchInput.value = '';
                
            } catch (error) {
                console.error('Error adding stock:', error);
                showAlert(error.message || 'Failed to add stock to watchlist', 'error');
            }
        }

        async function loadMarketData() {
            try {
                const response = await fetch(`${API_BASE}/market/symbols`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load market data');
                }

                const symbols = await response.json();
                updateMarketGrid(symbols);
                
            } catch (error) {
                console.error('Error loading market data:', error);
            }
        }

        function updateMarketGrid(symbols) {
            const marketGrid = document.getElementById('marketGrid');
            
            // Clear existing static cards
            marketGrid.innerHTML = '';
            
            // Add cards for each active symbol
            symbols.forEach(symbol => {
                const stockCard = document.createElement('div');
                stockCard.className = 'stock-card';
                stockCard.innerHTML = `
                    <div class="stock-symbol">${symbol.symbol}</div>
                    <div class="stock-price" id="price-${symbol.symbol}">--</div>
                    <div class="stock-change" id="change-${symbol.symbol}">--</div>
                `;
                
                // Add button container
                const buttonContainer = document.createElement('div');
                buttonContainer.style.display = 'flex';
                buttonContainer.style.gap = '8px';
                buttonContainer.style.marginTop = '10px';
                
                // Add buy button
                const buyButton = document.createElement('button');
                buyButton.className = 'buy-btn';
                buyButton.textContent = 'Buy';
                buyButton.style.flex = '1';
                buyButton.onclick = function() {
                    openBuyModal(symbol.symbol, symbol.companyName);
                };
                
                // Add view chart button
                const chartButton = document.createElement('button');
                chartButton.className = 'view-chart-btn';
                chartButton.textContent = 'Chart';
                chartButton.style.flex = '1';
                chartButton.onclick = function() {
                    openChartModal(symbol.symbol, symbol.companyName);
                };
                
                // Add financials button
                const financialsButton = document.createElement('button');
                financialsButton.className = 'view-financials-btn';
                financialsButton.textContent = 'Financials';
                financialsButton.style.flex = '1';
                financialsButton.onclick = function() {
                    openFinancialsModal(symbol.symbol, symbol.companyName);
                };
                
                buttonContainer.appendChild(buyButton);
                buttonContainer.appendChild(chartButton);
                buttonContainer.appendChild(financialsButton);
                stockCard.appendChild(buttonContainer);
                
                marketGrid.appendChild(stockCard);
            });
        }

        // Initialize market data when dashboard loads
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listener for search functionality
            const searchInput = document.getElementById('stockSearchInput');
            if (searchInput) {
                // Re-attach event listeners after DOM is ready
                searchInput.addEventListener('input', function() {
                    const query = this.value.trim();
                    clearTimeout(searchTimeout);
                    
                    if (query.length < 2) {
                        hideSearchResults();
                        return;
                    }
                    
                    searchTimeout = setTimeout(() => {
                        searchStocks(query);
                    }, 300);
                });
            }
        });

        // Watchlist Management Functions
        async function loadWatchlist(forceRefresh = false) {
            try {
                console.log('Loading watchlist...');
                
                // Check cache first
                const now = Date.now();
                if (!forceRefresh && cachedWatchlist && watchlistCacheTime && 
                    (now - watchlistCacheTime) < CACHE_DURATION) {
                    console.log('Using cached watchlist');
                    updateWatchlistDisplay(cachedWatchlist);
                    return;
                }
                
                // Don't require authentication for watchlist endpoint since it's public
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                // Add authentication if available
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                console.log('Fetching watchlist from:', `${API_BASE}/market/watchlist`);
                console.log('Using headers:', headers);
                
                const response = await fetch(`${API_BASE}/market/watchlist`, {
                    headers: headers
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error:', errorText);
                    throw new Error(`Failed to load watchlist: ${response.status} ${response.statusText} - ${errorText}`);
                }

                const watchlist = await response.json();
                console.log('Loaded watchlist:', watchlist);
                console.log('Watchlist type:', typeof watchlist);
                console.log('Watchlist is array:', Array.isArray(watchlist));
                
                // Cache the results
                cachedWatchlist = watchlist;
                watchlistCacheTime = now;
                console.log('Watchlist cached for 5 minutes');
                
                updateWatchlistDisplay(watchlist);
                
            } catch (error) {
                console.error('Error loading watchlist:', error);
                // Show empty watchlist message on error
                const watchlistItems = document.getElementById('watchlistItems');
                if (watchlistItems) {
                    watchlistItems.innerHTML = `
                        <div class="watchlist-empty">
                            No stocks in watchlist. Search and add stocks above.
                        </div>
                    `;
                }
            }
        }

        function updateWatchlistDisplay(symbols) {
            console.log('updateWatchlistDisplay called with:', symbols);
            console.log('Number of symbols:', symbols ? symbols.length : 'symbols is null/undefined');
            
            const watchlistItems = document.getElementById('watchlistItems');
            console.log('watchlistItems element:', watchlistItems);
            
            if (!watchlistItems) {
                console.error('watchlistItems element not found!');
                return;
            }
            
            if (!symbols || symbols.length === 0) {
                console.log('No symbols to display, showing empty message');
                watchlistItems.innerHTML = `
                    <div class="watchlist-empty">
                        No stocks in watchlist. Search and add stocks above.
                    </div>
                `;
                return;
            }

            console.log('Creating watchlist HTML for', symbols.length, 'symbols');
            const watchlistHtml = symbols.map(symbol => {
                console.log('Processing symbol:', symbol);
                return `
                <div class="watchlist-item" data-symbol="${symbol.symbol}">
                    <div class="watchlist-item-info">
                        <div class="watchlist-item-symbol">${symbol.symbol}</div>
                        <div class="watchlist-item-name">${symbol.companyName}</div>
                    </div>
                    <div class="watchlist-item-price" id="watchlist-price-${symbol.symbol}">--</div>
                    <div class="watchlist-item-actions">
                        <button class="view-chart-btn" onclick="openChartModal('${symbol.symbol}', '${symbol.companyName}')" style="padding: 4px 8px; font-size: 10px;">
                            Chart
                        </button>
                        <button class="view-financials-btn" onclick="openFinancialsModal('${symbol.symbol}', '${symbol.companyName}')" style="padding: 4px 8px; font-size: 10px;">
                            Financials
                        </button>
                        <button class="watchlist-buy-btn" onclick="openBuyModal('${symbol.symbol}', '${symbol.companyName}')">
                            Buy
                        </button>
                        <button class="watchlist-remove-btn" onclick="removeFromWatchlist('${symbol.symbol}')">
                            Remove
                        </button>
                    </div>
                </div>
            `;
            }).join('');

            console.log('Setting watchlist HTML:', watchlistHtml);
            watchlistItems.innerHTML = watchlistHtml;
            console.log('Watchlist HTML set, now fetching prices');
            
            // Fetch current prices for watchlist items
            symbols.forEach(symbol => {
                fetchCurrentPrice(symbol.symbol);
            });
        }
        
        async function fetchCurrentPrice(symbol) {
            try {
                const response = await fetch(`${API_BASE}/market/data/${symbol}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const marketData = await response.json();
                    if (marketData && marketData.price) {
                        const watchlistPriceElement = document.getElementById(`watchlist-price-${symbol}`);
                        if (watchlistPriceElement) {
                            watchlistPriceElement.textContent = `$${marketData.price}`;
                        }
                    }
                }
            } catch (error) {
                console.log(`Could not fetch current price for ${symbol}:`, error);
            }
        }

        async function removeFromWatchlist(symbol) {
            if (!confirm(`Remove ${symbol} from your watchlist?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/market/remove/${symbol}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to remove stock from watchlist');
                }

                // Show success message
                showAlert(`Successfully removed ${symbol} from your watchlist!`, 'success');
                
                // Clear cache and refresh watchlist and market data
                cachedWatchlist = null;
                watchlistCacheTime = null;
                loadWatchlist(true); // Force refresh
                loadMarketData();
                
            } catch (error) {
                console.error('Error removing stock:', error);
                showAlert(error.message || 'Failed to remove stock from watchlist', 'error');
            }
        }

        // Update watchlist prices when market data changes
        function updateWatchlistPrices(marketData) {
            if (marketData && marketData.symbol) {
                const priceElement = document.getElementById(`watchlist-price-${marketData.symbol}`);
                if (priceElement) {
                    priceElement.textContent = `$${marketData.price}`;
                    
                    // Add price change animation
                    priceElement.style.color = '#28a745';
                    setTimeout(() => {
                        priceElement.style.color = '#333';
                    }, 1000);
                }
            }
        }

        // Update the onLoginSuccess function to load watchlist
        const originalOnLoginSuccess = onLoginSuccess;
        function onLoginSuccess() {
            originalOnLoginSuccess();
            loadWatchlist();
        }

        // Buy Modal Functions
        let currentBuyStock = null;

        function openBuyModal(symbol, companyName) {
            if (!authToken) {
                showAlert('Please login first to buy stocks', 'error');
                return;
            }

            currentBuyStock = { symbol, companyName };
            
            // Populate modal fields
            document.getElementById('buySymbol').value = symbol;
            document.getElementById('buyCompanyName').value = companyName;
            document.getElementById('buyQuantity').value = 1;
            document.getElementById('buyOrderType').value = 'MARKET';
            document.getElementById('priceField').style.display = 'none';
            
            // Get current price and update summary
            updateOrderSummary();
            
            // Show modal
            document.getElementById('buyModal').style.display = 'block';
        }

        function closeBuyModal() {
            document.getElementById('buyModal').style.display = 'none';
            document.getElementById('buyForm').reset();
            currentBuyStock = null;
        }

        function togglePriceField() {
            const orderType = document.getElementById('buyOrderType').value;
            const priceField = document.getElementById('priceField');
            
            if (orderType === 'LIMIT') {
                priceField.style.display = 'block';
                document.getElementById('buyPrice').required = true;
            } else {
                priceField.style.display = 'none';
                document.getElementById('buyPrice').required = false;
            }
            
            updateOrderSummary();
        }

        function updateOrderSummary() {
            if (!currentBuyStock) return;
            
            const quantity = parseInt(document.getElementById('buyQuantity').value) || 1;
            const orderType = document.getElementById('buyOrderType').value;
            const limitPrice = parseFloat(document.getElementById('buyPrice').value) || 0;
            
            // Get current price from the market grid
            const priceElement = document.getElementById(`price-${currentBuyStock.symbol}`);
            const currentPriceText = priceElement ? priceElement.textContent : '--';
            const currentPrice = currentPriceText.startsWith('$') ? 
                parseFloat(currentPriceText.substring(1)) : 0;
            
            // Update current price display
            document.getElementById('currentPrice').textContent = currentPriceText;
            document.getElementById('summaryQuantity').textContent = quantity;
            
            if (currentPrice > 0) {
                const usePrice = orderType === 'LIMIT' && limitPrice > 0 ? limitPrice : currentPrice;
                const estimatedValue = usePrice * quantity;
                const fees = estimatedValue * 0.001; // 0.1% fee
                const totalAmount = estimatedValue + fees;
                
                document.getElementById('estimatedValue').textContent = `$${estimatedValue.toFixed(2)}`;
                document.getElementById('estimatedFees').textContent = `$${fees.toFixed(2)}`;
                document.getElementById('totalAmount').textContent = `$${totalAmount.toFixed(2)}`;
            } else {
                document.getElementById('estimatedValue').textContent = '--';
                document.getElementById('estimatedFees').textContent = '--';
                document.getElementById('totalAmount').textContent = '--';
            }
        }

        // Buy form event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const buyForm = document.getElementById('buyForm');
            if (buyForm) {
                buyForm.addEventListener('submit', handleBuyOrder);
            }
            
            // Update summary when quantity changes
            const quantityInput = document.getElementById('buyQuantity');
            if (quantityInput) {
                quantityInput.addEventListener('input', updateOrderSummary);
            }
            
            const priceInput = document.getElementById('buyPrice');
            if (priceInput) {
                priceInput.addEventListener('input', updateOrderSummary);
            }
            
            // Sell form event listeners
            const sellForm = document.getElementById('sellForm');
            if (sellForm) {
                sellForm.addEventListener('submit', handleSellOrder);
            }
            
            // Update sell summary when quantity changes
            const sellQuantityInput = document.getElementById('sellQuantity');
            if (sellQuantityInput) {
                sellQuantityInput.addEventListener('input', updateSellOrderSummary);
            }
            
            const sellPriceInput = document.getElementById('sellPrice');
            if (sellPriceInput) {
                sellPriceInput.addEventListener('input', updateSellOrderSummary);
            }
            
            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                const buyModal = document.getElementById('buyModal');
                const sellModal = document.getElementById('sellModal');
                if (event.target === buyModal) {
                    closeBuyModal();
                }
                if (event.target === sellModal) {
                    closeSellModal();
                }
            });
        });

        async function handleBuyOrder(e) {
            e.preventDefault();
            
            if (!currentBuyStock || !authToken) {
                showAlert('Please login first', 'error');
                return;
            }
            
            const formData = new FormData(e.target);
            const orderData = {
                symbol: currentBuyStock.symbol,
                orderType: document.getElementById('buyOrderType').value,
                side: 'BUY',
                quantity: parseInt(document.getElementById('buyQuantity').value)
            };
            
            // Add price for limit orders
            if (orderData.orderType === 'LIMIT') {
                const limitPrice = parseFloat(document.getElementById('buyPrice').value);
                if (!limitPrice || limitPrice <= 0) {
                    showAlert('Please enter a valid limit price', 'error');
                    return;
                }
                orderData.price = limitPrice;
            }
            
            try {
                // Disable submit button
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Placing Order...';
                
                const response = await fetch(`${API_BASE}/orders`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert(`Buy order placed successfully for ${orderData.quantity} shares of ${currentBuyStock.symbol}!`, 'success');
                    closeBuyModal();
                    
                    // Refresh portfolio data
                    loadPortfolio();
                    
                    // Add message to feed
                    addMessage(`📋 Buy order placed: ${orderData.quantity} shares of ${currentBuyStock.symbol}`, 'portfolio-update');
                } else {
                    showAlert(result.message || 'Failed to place buy order', 'error');
                }
                
            } catch (error) {
                console.error('Error placing buy order:', error);
                showAlert('Network error. Please try again.', 'error');
            } finally {
                // Re-enable submit button
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Place Buy Order';
            }
        }

        // Sell Modal Functions
        let currentSellStock = null;
        let maxAvailableShares = 0;

        function openSellModal(symbol, companyName, availableShares) {
            if (!authToken) {
                showAlert('Please login first to sell stocks', 'error');
                return;
            }

            currentSellStock = { symbol, companyName };
            maxAvailableShares = availableShares;
            
            // Populate modal fields
            document.getElementById('sellSymbol').value = symbol;
            document.getElementById('sellCompanyName').value = companyName;
            document.getElementById('sellQuantity').value = 1;
            document.getElementById('sellQuantity').max = availableShares;
            document.getElementById('maxQuantityText').textContent = `Max: ${availableShares} shares`;
            document.getElementById('sellOrderType').value = 'MARKET';
            document.getElementById('sellPriceField').style.display = 'none';
            
            // Get current price and update summary
            updateSellOrderSummary();
            
            // Show modal
            document.getElementById('sellModal').style.display = 'block';
        }

        function closeSellModal() {
            document.getElementById('sellModal').style.display = 'none';
            document.getElementById('sellForm').reset();
            currentSellStock = null;
            maxAvailableShares = 0;
        }

        function toggleSellPriceField() {
            const orderType = document.getElementById('sellOrderType').value;
            const priceField = document.getElementById('sellPriceField');
            
            if (orderType === 'LIMIT') {
                priceField.style.display = 'block';
                document.getElementById('sellPrice').required = true;
            } else {
                priceField.style.display = 'none';
                document.getElementById('sellPrice').required = false;
            }
            
            updateSellOrderSummary();
        }

        function updateSellOrderSummary() {
            if (!currentSellStock) return;
            
            const quantity = parseInt(document.getElementById('sellQuantity').value) || 1;
            const orderType = document.getElementById('sellOrderType').value;
            const limitPrice = parseFloat(document.getElementById('sellPrice').value) || 0;
            
            // Validate quantity
            if (quantity > maxAvailableShares) {
                document.getElementById('sellQuantity').value = maxAvailableShares;
                return;
            }
            
            // Get current price from the market grid
            const priceElement = document.getElementById(`price-${currentSellStock.symbol}`);
            const currentPriceText = priceElement ? priceElement.textContent : '--';
            const currentPrice = currentPriceText.startsWith('$') ? 
                parseFloat(currentPriceText.substring(1)) : 0;
            
            // Update current price display
            document.getElementById('sellCurrentPrice').textContent = currentPriceText;
            document.getElementById('sellSummaryQuantity').textContent = quantity;
            
            if (currentPrice > 0) {
                const usePrice = orderType === 'LIMIT' && limitPrice > 0 ? limitPrice : currentPrice;
                const estimatedValue = usePrice * quantity;
                const fees = estimatedValue * 0.001; // 0.1% fee
                const netAmount = estimatedValue - fees;
                
                document.getElementById('sellEstimatedValue').textContent = `$${estimatedValue.toFixed(2)}`;
                document.getElementById('sellEstimatedFees').textContent = `$${fees.toFixed(2)}`;
                document.getElementById('sellNetAmount').textContent = `$${netAmount.toFixed(2)}`;
            } else {
                document.getElementById('sellEstimatedValue').textContent = '--';
                document.getElementById('sellEstimatedFees').textContent = '--';
                document.getElementById('sellNetAmount').textContent = '--';
            }
        }

        async function handleSellOrder(e) {
            e.preventDefault();
            
            if (!currentSellStock || !authToken) {
                showAlert('Please login first', 'error');
                return;
            }
            
            const quantity = parseInt(document.getElementById('sellQuantity').value);
            
            if (quantity > maxAvailableShares) {
                showAlert(`You can only sell up to ${maxAvailableShares} shares`, 'error');
                return;
            }
            
            const orderData = {
                symbol: currentSellStock.symbol,
                orderType: document.getElementById('sellOrderType').value,
                side: 'SELL',
                quantity: quantity
            };
            
            // Add price for limit orders
            if (orderData.orderType === 'LIMIT') {
                const limitPrice = parseFloat(document.getElementById('sellPrice').value);
                if (!limitPrice || limitPrice <= 0) {
                    showAlert('Please enter a valid limit price', 'error');
                    return;
                }
                orderData.price = limitPrice;
            }
            
            try {
                // Disable submit button
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Placing Order...';
                
                const response = await fetch(`${API_BASE}/orders`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert(`Sell order placed successfully for ${orderData.quantity} shares of ${currentSellStock.symbol}!`, 'success');
                    closeSellModal();
                    
                    // Refresh portfolio data
                    loadPortfolio();
                    
                    // Add message to feed
                    addMessage(`📋 Sell order placed: ${orderData.quantity} shares of ${currentSellStock.symbol}`, 'portfolio-update');
                } else {
                    showAlert(result.message || 'Failed to place sell order', 'error');
                }
                
            } catch (error) {
                console.error('Error placing sell order:', error);
                showAlert('Network error. Please try again.', 'error');
            } finally {
                // Re-enable submit button
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Place Sell Order';
            }
        }

        // Add Balance Modal Functions
        function openAddBalanceModal() {
            if (!authToken) {
                showAlert('Please login first to add balance', 'error');
                return;
            }

            // Reset form
            document.getElementById('addBalanceForm').reset();
            updateBalanceSummary();
            
            // Show modal
            document.getElementById('addBalanceModal').style.display = 'block';
            
            // Initialize payment method selection (no method selected by default)
            const paypalContainer = document.getElementById('paypal-add-balance-container');
            const regularButton = document.getElementById('regular-add-balance');
            paypalContainer.style.display = 'none';
            regularButton.style.display = 'none';
        }

        function closeAddBalanceModal() {
            document.getElementById('addBalanceModal').style.display = 'none';
            document.getElementById('addBalanceForm').reset();
        }

        function updateBalanceSummary() {
            const amount = parseFloat(document.getElementById('addBalanceAmount').value) || 0;
            const fee = amount * 0.01; // 1% transaction fee
            const total = amount + fee;
            
            document.getElementById('summaryAmount').textContent = `$${amount.toFixed(2)}`;
            document.getElementById('transactionFee').textContent = `$${fee.toFixed(2)}`;
            document.getElementById('totalCharge').textContent = `$${total.toFixed(2)}`;
        }

        function togglePaymentMethod() {
            const paymentMethod = document.getElementById('addBalanceMethod').value;
            const paypalContainer = document.getElementById('paypal-add-balance-container');
            const regularButton = document.getElementById('regular-add-balance');
            
            if (paymentMethod === 'PAYPAL') {
                // Show PayPal button, hide regular button
                paypalContainer.style.display = 'block';
                regularButton.style.display = 'none';
                
                // Clear and render PayPal button
                paypalContainer.innerHTML = '';
                setTimeout(renderPayPalAddBalanceButton, 100);
            } else if (paymentMethod === '') {
                // No payment method selected - hide both
                paypalContainer.style.display = 'none';
                regularButton.style.display = 'none';
            } else {
                // Show regular button, hide PayPal button
                paypalContainer.style.display = 'none';
                regularButton.style.display = 'block';
            }
        }

        function renderPayPalAddBalanceButton() {
            const amount = parseFloat(document.getElementById('addBalanceAmount').value);
            const paypalContainer = document.getElementById('paypal-add-balance-container');
            const regularButton = document.getElementById('regular-add-balance');
            
            if (!amount || amount <= 0) {
                // Show message in PayPal container if no amount
                paypalContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Please enter an amount first</div>';
                return;
            }
            
            if (typeof paypal === 'undefined') {
                // Show error message if PayPal SDK not loaded
                paypalContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">PayPal SDK not loaded. Please try again.</div>';
                return;
            }
            
            paypal.Buttons({
                createOrder: function(data, actions) {
                    const total = amount;
                    
                    if (total <= 0) {
                        showAlert('Please enter a valid amount', 'error');
                        return;
                    }
                    
                    return actions.order.create({
                        purchase_units: [{
                            description: 'Stock Brokerage Account Balance Addition',
                            amount: {
                                currency_code: 'USD',
                                value: total.toFixed(2)
                            }
                        }]
                    });
                },
                
                onApprove: function(data, actions) {
                    return actions.order.capture().then(function(orderData) {
                        console.log('Payment successful:', orderData);
                        
                        // Call backend to add balance
                        return capturePayPalPayment(orderData.id, amount);
                    });
                },
                
                onError: function(err) {
                    console.error('PayPal error:', err);
                    showAlert('Payment error occurred. Please try again.', 'error');
                },
                
                onCancel: function(data) {
                    console.log('Payment cancelled:', data);
                    showAlert('Payment was cancelled', 'error');
                },
                
                style: {
                    layout: 'vertical',
                    color: 'blue',
                    shape: 'rect',
                    height: 50,
                    label: 'pay'
                }
            }).render('#paypal-add-balance-container');
        }
        
        async function capturePayPalPayment(orderId, amount) {
            try {
                const response = await fetch(`${API_BASE}/wallet/paypal/capture-order/${orderId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert(`Successfully added $${amount.toFixed(2)} to your account via PayPal!`, 'success');
                    closeAddBalanceModal();
                    
                    // Refresh portfolio data to show updated balance
                    loadPortfolio();
                    
                    // Add message to feed
                    addMessage(`💰 Balance added: $${amount.toFixed(2)} via PayPal`, 'portfolio-update');
                } else {
                    showAlert(result.message || 'Failed to process payment', 'error');
                }
            } catch (error) {
                console.error('Error capturing PayPal payment:', error);
                showAlert('Network error. Please try again.', 'error');
            }
        }

        async function handleAddBalance(e) {
            e.preventDefault();
            
            if (!authToken) {
                showAlert('Please login first', 'error');
                return;
            }
            
            const amount = parseFloat(document.getElementById('addBalanceAmount').value);
            const paymentMethod = document.getElementById('addBalanceMethod').value;
            
            if (!amount || amount <= 0) {
                showAlert('Please enter a valid amount', 'error');
                return;
            }
            
            if (!paymentMethod) {
                showAlert('Please select a payment method', 'error');
                return;
            }
            
            if (paymentMethod === 'PAYPAL') {
                showAlert('Please use the PayPal button below to complete your payment', 'error');
                return;
            }
            
            try {
                // Disable submit button
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Processing...';
                
                const response = await fetch(`${API_BASE}/wallet/add-balance`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: amount,
                        paymentMethod: paymentMethod
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert(`Successfully added $${amount.toFixed(2)} to your account!`, 'success');
                    closeAddBalanceModal();
                    
                    // Refresh portfolio data to show updated balance
                    loadPortfolio();
                    
                    // Add message to feed
                    addMessage(`💰 Balance added: $${amount.toFixed(2)} via ${paymentMethod}`, 'portfolio-update');
                } else {
                    showAlert(result.message || 'Failed to add balance', 'error');
                }
                
            } catch (error) {
                console.error('Error adding balance:', error);
                showAlert('Network error. Please try again.', 'error');
            } finally {
                // Re-enable submit button
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Balance';
            }
        }

        // Add event listeners when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Existing event listeners...
            
            // Add balance form
            const addBalanceForm = document.getElementById('addBalanceForm');
            if (addBalanceForm) {
                addBalanceForm.addEventListener('submit', handleAddBalance);
            }
            
            // Update summary when amount changes
            const amountInput = document.getElementById('addBalanceAmount');
            if (amountInput) {
                amountInput.addEventListener('input', function() {
                    updateBalanceSummary();
                    // Re-render PayPal button if PayPal is selected and modal is open
                    const paymentMethod = document.getElementById('addBalanceMethod').value;
                    if (paymentMethod === 'PAYPAL' && document.getElementById('addBalanceModal').style.display === 'block') {
                        document.getElementById('paypal-add-balance-container').innerHTML = '';
                        setTimeout(renderPayPalAddBalanceButton, 100);
                    }
                });
            }
            
            // Handle payment method changes
            const paymentMethodSelect = document.getElementById('addBalanceMethod');
            if (paymentMethodSelect) {
                paymentMethodSelect.addEventListener('change', togglePaymentMethod);
            }
            
            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                const addBalanceModal = document.getElementById('addBalanceModal');
                if (event.target === addBalanceModal) {
                    closeAddBalanceModal();
                }
            });
        });

        // Chart Modal Functions
        let currentChart = null;
        let currentChartSymbol = null;
        let currentChartPeriod = '1M';

        function openChartModal(symbol, companyName) {
            currentChartSymbol = symbol;
            currentChartPeriod = '1M';
            
            // Update modal title
            document.getElementById('chartTitle').textContent = `${symbol} - ${companyName || symbol}`;
            
            // Reset period buttons
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.period === currentChartPeriod) {
                    btn.classList.add('active');
                }
            });
            
            // Show modal
            document.getElementById('chartModal').style.display = 'block';
            
            // Load chart data
            loadChartData(symbol, currentChartPeriod);
        }

        function closeChartModal() {
            document.getElementById('chartModal').style.display = 'none';
            
            // Destroy existing chart
            if (currentChart) {
                currentChart.destroy();
                currentChart = null;
            }
            
            currentChartSymbol = null;
        }

        async function loadChartData(symbol, period) {
            const chartLoading = document.getElementById('chartLoading');
            const chartError = document.getElementById('chartError');
            const chartCanvas = document.getElementById('stockChart');
            
            // Show loading state
            chartLoading.style.display = 'flex';
            chartError.style.display = 'none';
            chartCanvas.style.display = 'none';
            
            // Destroy existing chart
            if (currentChart) {
                currentChart.destroy();
                currentChart = null;
            }
            
            try {
                const response = await fetch(`${API_BASE}/historical/chart/${symbol}?period=${period}`, {
                    headers: {
                        'Authorization': authToken ? `Bearer ${authToken}` : '',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const chartData = await response.json();
                
                if (!chartData.data || chartData.data.length === 0) {
                    throw new Error('No data available for this symbol');
                }
                
                // Hide loading, show chart
                chartLoading.style.display = 'none';
                chartCanvas.style.display = 'block';
                
                // Create the chart
                createStockChart(chartData);
                
            } catch (error) {
                console.error('Error loading chart data:', error);
                
                // Show error state
                chartLoading.style.display = 'none';
                chartError.style.display = 'flex';
                chartError.textContent = `Failed to load chart data: ${error.message}`;
            }
        }

        function createStockChart(chartData) {
            const ctx = document.getElementById('stockChart').getContext('2d');
            
            // Prepare data for Chart.js
            const labels = [];
            const prices = [];
            const volumes = [];
            
            chartData.data.forEach(point => {
                labels.push(new Date(point.timestamp));
                prices.push(parseFloat(point.close));
                volumes.push(point.volume);
            });
            
            // Determine time unit based on period
            let timeUnit = 'day';
            const period = currentChartPeriod;
            if (period === '1D') timeUnit = 'hour';
            else if (period === '1W') timeUnit = 'day';
            else if (period === '1M' || period === '3M') timeUnit = 'day';
            else if (period === '1Y') timeUnit = 'month';
            
            // Create gradient for price line
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(102, 126, 234, 0.4)');
            gradient.addColorStop(1, 'rgba(102, 126, 234, 0.05)');
            
            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${chartData.symbol} Price`,
                        data: prices,
                        borderColor: '#667eea',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        pointHoverBackgroundColor: '#667eea',
                        pointHoverBorderColor: '#ffffff',
                        pointHoverBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#667eea',
                            borderWidth: 1,
                            displayColors: false,
                            callbacks: {
                                title: function(context) {
                                    return new Date(context[0].parsed.x).toLocaleString();
                                },
                                label: function(context) {
                                    return `Price: $${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: timeUnit
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: '#666666'
                            }
                        },
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: '#666666',
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        }
                    },
                    elements: {
                        point: {
                            hoverRadius: 8
                        }
                    }
                }
            });
        }

        // Period button event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners for period buttons
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (currentChartSymbol) {
                        // Update active button
                        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        
                        // Update current period and reload data
                        currentChartPeriod = this.dataset.period;
                        loadChartData(currentChartSymbol, currentChartPeriod);
                    }
                });
            });
            
            // Close chart modal when clicking outside
            window.addEventListener('click', function(event) {
                const chartModal = document.getElementById('chartModal');
                const financialsModal = document.getElementById('financialsModal');
                if (event.target === chartModal) {
                    closeChartModal();
                }
                if (event.target === financialsModal) {
                    closeFinancialsModal();
                }
            });
        });

        // Financials Modal Functions
        let currentFinancialsSymbol = null;

        function openFinancialsModal(symbol, companyName) {
            currentFinancialsSymbol = symbol;
            
            // Update modal title
            document.getElementById('financialsTitle').textContent = `Company Financials - ${symbol} ${companyName ? '(' + companyName + ')' : ''}`;
            
            // Show modal
            document.getElementById('financialsModal').style.display = 'block';
            
            // Load financial data
            loadFinancialData(symbol);
        }

        function closeFinancialsModal() {
            document.getElementById('financialsModal').style.display = 'none';
            currentFinancialsSymbol = null;
        }

        async function loadFinancialData(symbol) {
            const financialsLoading = document.getElementById('financialsLoading');
            const financialsError = document.getElementById('financialsError');
            const financialsData = document.getElementById('financialsData');
            
            // Show loading state
            financialsLoading.style.display = 'block';
            financialsError.style.display = 'none';
            financialsData.style.display = 'none';
            
            try {
                const response = await fetch(`${API_BASE}/financials/basic/${symbol}`, {
                    headers: {
                        'Authorization': authToken ? `Bearer ${authToken}` : '',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.metric || Object.keys(data.metric).length === 0) {
                    throw new Error('No financial data available for this symbol');
                }
                
                // Hide loading, show data
                financialsLoading.style.display = 'none';
                financialsData.style.display = 'block';
                
                // Populate financial data
                populateFinancialData(data);
                
            } catch (error) {
                console.error('Error loading financial data:', error);
                
                // Show error state
                financialsLoading.style.display = 'none';
                financialsError.style.display = 'block';
                financialsError.textContent = `Failed to load financial data: ${error.message}`;
            }
        }

        function populateFinancialData(data) {
            const metric = data.metric;
            
            // Populate key metrics
            document.getElementById('marketCap').textContent = formatNumber(metric.marketCapitalization, 'currency');
            document.getElementById('peRatio').textContent = formatNumber(metric.peTTM, 'decimal');
            document.getElementById('pbRatio').textContent = formatNumber(metric.pb, 'decimal');
            document.getElementById('eps').textContent = formatNumber(metric.epsTTM, 'currency');
            document.getElementById('dividendYield').textContent = formatNumber(metric.currentDividendYieldTTM, 'percent');
            document.getElementById('roe').textContent = formatNumber(metric.roeTTM, 'percent');
            document.getElementById('roa').textContent = formatNumber(metric.roaTTM, 'percent');
            document.getElementById('beta').textContent = formatNumber(metric.beta, 'decimal');
            document.getElementById('weekHigh52').textContent = formatNumber(metric['52WeekHigh'], 'currency');
            document.getElementById('weekLow52').textContent = formatNumber(metric['52WeekLow'], 'currency');
            
            // Populate additional metrics
            const additionalMetrics = document.getElementById('additionalMetrics');
            additionalMetrics.innerHTML = '';
            
            const additionalMetricsList = [
                { key: 'grossMarginTTM', label: 'Gross Margin (TTM)', format: 'percent' },
                { key: 'operatingMarginTTM', label: 'Operating Margin (TTM)', format: 'percent' },
                { key: 'netProfitMarginTTM', label: 'Net Profit Margin (TTM)', format: 'percent' },
                { key: 'currentRatioAnnual', label: 'Current Ratio', format: 'decimal' },
                { key: 'quickRatioAnnual', label: 'Quick Ratio', format: 'decimal' },
                { key: 'revenueGrowthTTMYoy', label: 'Revenue Growth (YoY)', format: 'percent' },
                { key: 'epsGrowthTTMYoy', label: 'EPS Growth (YoY)', format: 'percent' },
                { key: 'bookValuePerShareAnnual', label: 'Book Value Per Share', format: 'currency' },
                { key: 'cashFlowPerShareTTM', label: 'Cash Flow Per Share (TTM)', format: 'currency' },
                { key: 'revenuePerShareTTM', label: 'Revenue Per Share (TTM)', format: 'currency' }
            ];
            
            additionalMetricsList.forEach(item => {
                if (metric[item.key] !== undefined && metric[item.key] !== null) {
                    const metricItem = document.createElement('div');
                    metricItem.className = 'additional-metric-item';
                    metricItem.innerHTML = `
                        <div class="additional-metric-label">${item.label}</div>
                        <div class="additional-metric-value">${formatNumber(metric[item.key], item.format)}</div>
                    `;
                    additionalMetrics.appendChild(metricItem);
                }
            });
        }

        function formatNumber(value, format) {
            if (value === null || value === undefined || isNaN(value)) {
                return '--';
            }
            
            const num = parseFloat(value);
            
            switch (format) {
                case 'currency':
                    if (num >= 1e12) return `$${(num / 1e12).toFixed(2)}T`;
                    if (num >= 1e9) return `$${(num / 1e9).toFixed(2)}B`;
                    if (num >= 1e6) return `$${(num / 1e6).toFixed(2)}M`;
                    if (num >= 1e3) return `$${(num / 1e3).toFixed(2)}K`;
                    return `$${num.toFixed(2)}`;
                    
                case 'percent':
                    return `${num.toFixed(2)}%`;
                    
                case 'decimal':
                    return num.toFixed(2);
                    
                default:
                    return num.toString();
            }
        }
    </script>
</body>
</html>